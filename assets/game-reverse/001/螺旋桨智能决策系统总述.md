# 螺旋桨智能决策系统总述

## 📖 文档概述

本文档是某三消游戏中**螺旋桨（Propeller）智能决策系统**的完整技术文档集合。该系统是游戏中最复杂、最智能的道具攻击机制，通过多层次的分数计算和目标选择算法，确保螺旋桨总能选择最有价值的攻击目标。

### 🎯 系统核心价值

- **智能化：** 螺旋桨能根据棋盘状态自动选择最优攻击目标
- **通关导向：** 优先攻击能帮助玩家完成关卡目标的位置
- **策略多样：** 不同螺旋桨组合采用不同的攻击策略
- **平衡性：** 通过复杂的权重计算确保游戏平衡

## 🏗️ 系统架构总览

```
                    [玩家激活螺旋桨]
                           |
                    [策略层：四种攻击模式]
                    /      |      |      \
              TNT组合  垂直火箭  水平火箭  默认模式
                    \      |      |      /
                           |
                    [全局层：棋盘分数计算]
                           |
                  ┌────────┼────────┐
            全局扫描  特殊关卡  道具影响
                  └────────┼────────┘
                           |
                    [单元格层：单格权重]
                           |
                  ┌────────┼────────┐
            分层检查   缓存机制  爆炸适配
                  └────────┼────────┘
                           |
                    [道具层：81种棋子]
                           |
                  ┌────────┼────────┐
           权重算法  GetExplodeScore  28种模式
                  └────────┼────────┘
                           |
                    [影响因子层：16个Helper]
                           |
                  ┌────────┼────────┐
          跨棋子影响  Helper系统  42种关系
                  └────────┼────────┘
```

## 📊 系统统计数据

### 规模统计
- **攻击模式：** 4种核心模式
- **道具总数：** 81个不同道具类型
- **影响因子：** 16个影响因子棋子
- **受影响道具：** 17个（占21.0%）
- **独立计算道具：** 64个（占79.0%）
- **影响关系：** 42个跨棋子影响关系

### 复杂度分析
| 复杂度 | 道具数量 | 占比 | 典型代表 |
|--------|----------|------|----------|
| **简单** | 45个 | 55.6% | 水、钻头、原木 |
| **中等** | 25个 | 30.9% | 多格道具 |
| **复杂** | 8个 | 9.9% | 特殊道具、火柴 |
| **极复杂** | 3个 | 3.7% | 魔法方块、大头针 |

## 🧮 系统数学模型

### 核心计算公式

整个系统的权重计算可以用以下数学模型表示：

```
PropellerTarget = argmax_{(x,y)} [ -( CellScore(x,y) + SpecialBonus(x,y) ) ]
```

其中：

```
CellScore(x,y) = Σ [ BaseScore(item) + Σ InfluenceFactor_i(item) ]
                item∈Cell(x,y)              i=1..n
```

### 分层计算体系

| 层级 | 计算范围 | 数学表达 |
|------|----------|----------|
| **策略层** | 攻击模式选择 | Strategy = f(GuidedExploderType) |
| **全局层** | 整个棋盘 | BoardScore = ∪ CellScore(x,y) |
| **单元格层** | 单个位置 | CellScore = Σ ItemScore |
| **道具层** | 单个道具 | ItemScore = GetExplodeScore() |
| **影响因子层** | 跨道具影响 | InfluenceFactor = Σ Helper.GetScore() |

## 🎯 系统设计理念

### 核心设计原则

1. **🏆 通关优先原则**
   - 能帮助完成关卡目标的位置永远优先
   - 快速通关 > 高分数 > 兜底保障

2. **🎲 智能随机平衡**
   - 相同分数时随机选择，避免过于可预测
   - 保持游戏的趣味性和挑战性

3. **🔄 分层职责分离**
   - 每层负责特定的计算职责
   - 上层调用下层，下层为上层服务

4. **⚡ 性能优化机制**
   - 缓存机制避免重复计算
   - 条件判断减少不必要的处理

### 业务价值体现

1. **玩家体验优化**
   - 螺旋桨总能选择"聪明"的攻击目标
   - 帮助玩家更容易完成关卡

2. **游戏平衡保障**
   - 复杂的权重计算确保游戏平衡
   - 不同道具有不同的价值体现

3. **策略深度增强**
   - 道具间的相互影响增加策略性
   - 玩家需要考虑更多因素

4. **系统可扩展性**
   - 新道具只需实现权重计算接口
   - 新的影响关系可以通过Helper系统添加

## 🚀 五层权重计算体系详解

### 第一层：策略层 - 四种攻击模式

根据螺旋桨的组合类型，系统会切换不同的攻击策略：

#### 1. PropellerTntStrategy（TNT组合）
- **攻击模式：** 区域轰炸
- **计算方式：** 计算TNT爆炸范围内所有格子的总分
- **适用场景：** 大面积障碍物清理

#### 2. PropellerRocketStrategy（火箭组合）
- **攻击模式：** 整行/整列清除
- **计算方式：** 
  - 垂直火箭：计算每列总分，选择最高分列
  - 水平火箭：计算每行总分，选择最高分行
- **适用场景：** 需要清理特定行列的关卡

#### 3. PropellerDefaultStrategy（默认模式）
- **攻击模式：** 单点精准攻击
- **计算方式：** 遍历棋盘，计算每个位置分数，选择最高分位置
- **适用场景：** 大部分情况下的主要模式

### 第二层：全局层 - 棋盘分数计算

核心类：`ExplodeTargetFinder`

**主要职责：**
- 遍历整个棋盘，填充分数数组（FillScores）
- 根据不同策略选择最佳目标
- 处理特殊关卡逻辑（底部收集、收集青蛙等）

**关键算法：**
```
FindForExploder(exploder):
  1. 尝试策略级重定向（通关条件优先）
  2. 获取策略并执行目标寻找
  3. 返回最佳目标位置
```

### 第三层：单元格层 - 单格权重计算

核心类：`ExplodeTargetMediator`

**计算流程：**
1. 检查上方道具（如果会掉落）
2. 检查当前道具
3. 检查下方道具（如果被压着）
4. 特殊传播计算（果冻传播、TNT范围）

**优化机制：**
- 缓存机制：避免同一帧内重复计算同一格子
- 阻挡检测：跳过被钻头、原木等阻挡的位置

### 第四层：道具层 - 81种棋子独立评分

每个棋子实现自己的 `GetExplodeScore()` 方法。

**28种权重计算模式：**
- 固定权重：返回固定分数（如水、钻头）
- 标准最后一击：多格道具剩最后一层时加分
- 复杂条件权重：根据多种条件动态调整
- 分组协同：同类道具形成组，整组加分
- 位置相关：底部收集关卡，越靠下分数越高
- 目标相关：收集目标道具（青蛙、鸟）有巨额加成
- ...（其他22种模式）

**典型案例：青蛙（FrogItemModel）**
```csharp
GetExplodeScore(explodeData):
  if 单一爆炸器:
    return 868243
  else: // 组合爆炸器
    return 3838548  // 4.4倍加成！
```

**设计原因：** 青蛙是关卡目标，必须给予高权重确保螺旋桨优先攻击。

### 第五层：影响因子层 - 16个Helper系统

某些特殊棋子不仅自己有权重，还会影响其他棋子的分数。

**典型Helper系统：**

#### IceCubeHelper（冰块影响因子）
- 影响5种特殊道具的分数
- 有独立的重定向逻辑
- 在底部收集关卡中有额外加成

#### FrogHelper（青蛙影响因子）
- 4.4倍加成机制
- 确保螺旋桨优先选择青蛙

#### BirdHelper（鸟类影响因子）
- 跨棋子影响
- 特殊掉落逻辑

**统计数据：**
- 16个Helper系统
- 42个跨棋子影响关系
- 17个受影响的道具类型

## 🔄 三层重定向机制

螺旋桨选中目标后，不一定会直接飞过去，还有重定向机制。

### 第一层：策略级重定向
**检查通关条件**
```
TryRedirectForSoilWinCondition():
  if 关卡有土壤 AND 某位置只剩最后一层:
    强制重定向到该位置

TryRedirectForPowerCubeWinCondition():
  if 关卡有能量方块 AND 能量方块剩最后一层:
    强制重定向
```

### 第二层：道具级重定向
某些道具会主动告诉螺旋桨"别打我，打旁边那个"。

**典型案例：**
- 多层障碍物：让螺旋桨攻击其支撑点
- 特殊道具：触发重新寻找目标

### 第三层：Helper级重定向
**最复杂：IceCubeHelper重定向**
```
CheckIceCubeRedirect(cell):
  1. 检查冰块上方有没有收集物品（青蛙、鸟）
  2. 根据冰块类型（真冰块/假冰块）
  3. 计算重定向方向（向上搜索→左右邻居→同列最近位置）
  4. 重定向到能帮助收集物品掉落的位置
```

## 🔍 常见问题解答

### Q1: 为什么螺旋桨有时候选择看起来不是最优的目标？
**A:** 螺旋桨遵循"通关优先"原则，可能会选择能帮助完成关卡目标的位置，而不是分数最高的位置。重定向机制也可能改变最初的选择。

### Q2: 不同螺旋桨组合的区别在哪里？
**A:** 主要区别在攻击模式：TNT组合进行区域轰炸，火箭组合进行行/列攻击，普通螺旋桨进行单点攻击。不同模式的分数计算方式完全不同。

### Q3: 道具之间是如何相互影响的？
**A:** 通过影响因子系统，16个特殊道具可以影响其他道具的权重计算，共有42种跨棋子影响关系。

### Q4: 青蛙为什么有4.4倍加成？
**A:** 青蛙是关卡目标。如果螺旋桨老是忽略青蛙，玩家会骂人。4.4倍加成确保青蛙几乎总是最高优先级目标。

### Q5: 系统的性能如何保障？
**A:** 通过多级缓存机制、条件判断优化、以及分层计算来保障性能。同一帧内对同一格子的分数查询会直接返回缓存值。

---

## 📈 技术复杂度评估

### 开发成本
- **预估开发时间：** 1年+
- **代码规模：** 2万+ C#代码
- **调优难度：** 极高（需大量测试和平衡）

### 逆向成本
- **传统方法预估：** 1年+（手动分析ARM汇编）
- **AI辅助实际耗时：** 1个月（业余时间）
- **AI还原精度：** 约85%
- **人工修正比例：** 15%

### 为什么需要这么复杂？
1. 玩家需要感觉道具"很聪明"才愿意付费
2. 螺旋桨是核心付费道具
3. "看起来聪明"比"真的聪明"更重要
4. 10倍开发成本带来100倍收益
5. 精细权重系统形成竞争壁垒

---

*本文档基于某三消游戏的IL2CPP逆向分析，所有技术细节均来自实际代码实现。*

**声明：** 本文档仅供学习和研究使用，请勿用于商业用途或破坏游戏平衡。

